name: R2 Upload Test

on:
  workflow_dispatch:

jobs:
  upload-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: Install boto3
        run: pip install boto3

      - name: Test R2 connection
        env:
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
        run: |
          python -c "import os, boto3; client=boto3.client('s3', region_name='auto', endpoint_url=f'https://{os.environ['R2_ACCOUNT_ID']}.r2.cloudflarestorage.com', aws_access_key_id=os.environ['R2_ACCESS_KEY_ID'], aws_secret_access_key=os.environ['R2_SECRET_ACCESS_KEY']); response=client.list_objects_v2(Bucket=os.environ['R2_BUCKET_NAME']); print('Objects in bucket:' if 'Contents' in response else 'Bucket is empty.'); print([obj['Key'] for obj in response.get('Contents', [])])"
